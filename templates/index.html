<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Asistente de IA - Proyectos TIC</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background:#f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .chat-container { max-width:800px; margin:2rem auto; background:white; border-radius:15px; box-shadow:0 0 20px rgba(0,0,0,0.1); }
    .chat-header { background:linear-gradient(135deg,#2c3e50,#3498db); color:white; padding:1rem; display:flex; justify-content:space-between; align-items:center; }
    .chat-messages { height:500px; overflow-y:auto; padding:1rem; background:#f8f9fa; }
    .message { margin-bottom:1rem; padding:1rem; border-radius:10px; max-width:80%; }
    .user-message { background:#e3f2fd; margin-left:auto; }
    .bot-message { background:white; margin-right:auto; box-shadow:0 2px 5px rgba(0,0,0,0.05); }
    .chat-input { padding:1rem; background:white; border-top:1px solid #eee; }
    .btn-send { border-radius:25px; padding:0.75rem 2rem; background:linear-gradient(135deg,#2c3e50,#3498db); border:none; color:white; }
    .option-button { display:block; width:100%; margin:.3rem 0; padding:.5rem; border:1px solid #ddd; border-radius:8px; text-align:left; }
    .option-button:hover { background:#f0f0f0; }

    /* Buen render para Markdown */
    .bot-message { white-space: normal; line-height: 1.5; }
    .bot-message h1 { font-size: 1.4rem; margin: .6rem 0; }
    .bot-message h2 { font-size: 1.2rem; margin: .5rem 0; }
    .bot-message h3 { font-size: 1.1rem; margin: .4rem 0; }
    .bot-message ul, .bot-message ol { padding-left: 1.2rem; }
    .bot-message code { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
  </style>
</head>
<body>
  <div class="container">
    <div class="chat-container">
      <div class="chat-header">
        <div>
          <h5 class="mb-0">Asistente de IA</h5>
          <small>Proyectos TIC</small>
        </div>
        <div>
          <button id="altChatBtn" class="btn btn-warning btn-sm">💬 Chat Libre</button>
          <button id="resetBtn" class="btn btn-danger btn-sm">🔄 Reiniciar</button>
        </div>
      </div>

      <div id="chatMessages" class="chat-messages"></div>

      <div class="chat-input">
        <form id="chatForm" class="d-flex gap-2">
          <input type="text" id="userInput" class="form-control" placeholder="Escribe tu mensaje..." autocomplete="off" />
          <button type="submit" class="btn btn-send">Enviar</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Markdown + Sanitizer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <script>
    let mode = "flow"; // por defecto flujo
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const userInput = document.getElementById('userInput');

    // Convertir Markdown -> HTML seguro
    function renderMarkdown(mdText) {
      const dirty = marked.parse(mdText || "", { mangle: false, headerIds: true });
      return DOMPurify.sanitize(dirty);
    }

    function addMessage(msg, sender) {
      const div = document.createElement('div');
      div.className = `message ${sender}-message`;
      // Renderizamos Markdown si viene del bot; el user va en texto literal
      if (sender === 'bot') {
        div.innerHTML = renderMarkdown(msg);
      } else {
        div.textContent = msg;
      }
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function addOptionsMessage(msg, options) {
      const div = document.createElement('div');
      div.className = 'message bot-message';
      let html = `<div>${renderMarkdown(msg)}</div>`;
      options.forEach(opt => {
        html += `<button class="option-button" data-option="${opt}">${opt}</button>`;
      });
      div.innerHTML = html;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      div.querySelectorAll('.option-button').forEach(btn=>{
        btn.addEventListener('click',()=>{
          addMessage(btn.dataset.option,'user');
          sendMessage(btn.dataset.option);
        });
      });
    }

    async function sendMessage(msg) {
      try {
        const endpoint = (mode === "alt") ? "/api/chat_alt" : "/api/chat";
        const res = await fetch(endpoint, {
          method:"POST",
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({message:msg})
        });
        const data = await res.json();

        if (data.response) {
          if (data.options && Array.isArray(data.options) && data.options.length) {
            addOptionsMessage(data.response, data.options);
          } else {
            addMessage(data.response, 'bot');
          }
        }
        if (msg.toLowerCase()==="finalizar" && mode==="alt") { mode="flow"; }
      } catch(err){
        addMessage("❌ Error en el servidor","bot");
      }
    }

    chatForm.addEventListener("submit",(e)=>{
      e.preventDefault();
      const msg=userInput.value.trim();
      if(!msg) return;
      addMessage(msg,'user');
      userInput.value="";
      sendMessage(msg);
    });

    document.getElementById("resetBtn").addEventListener("click", async ()=>{
      await fetch("/reset",{method:"POST"});
      chatMessages.innerHTML="";
      addMessage("🔄 Conversación reiniciada.","bot");
      mode="flow";
      sendMessage("iniciar");
    });

    document.getElementById("altChatBtn").addEventListener("click", ()=>{
      mode="alt";
      addMessage("🤖 Has activado el chat libre. Pregunta lo que quieras.\n\nEscribe **Finalizar** para volver al flujo.","bot");
    });

    // iniciar conversación automáticamente
    sendMessage("iniciar");
  </script>
</body>
</html>
